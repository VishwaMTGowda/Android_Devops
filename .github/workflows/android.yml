name: Android CI and CD

on:
  push:
    branches:
      - main
      - qa
      - develop
  pull_request:
    branches:
      - main
      - qa

env:
  JAVA_VERSION: "17"

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      CURRENT_DATE_TIME: ${{ steps.date.outputs.current_date_time }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: temurin
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Gradle Clean
      run: ./gradlew clean

    - name: Gradle Lint
      run: ./gradlew lint

    - name: Build APK
      run: ./gradlew build

    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      run: ./gradlew sonarqube -Dsonar.projectKey=android-demo-app

    - name: Capture Date-Time
      id: date
      run: echo "current_date_time=$(date +"%d-%m-%Y-%H-%M-%S")" >> $GITHUB_OUTPUT

    - name: Prepare APK Artifacts
      run: |
        mkdir -p apk-files/debug apk-files/release

        cp app/build/outputs/apk/debug/app-debug.apk \
           apk-files/debug/app-debug-${{ steps.date.outputs.current_date_time }}.apk

        cp app/build/outputs/apk/release/app-release-unsigned.apk \
           apk-files/release/app-release-${{ steps.date.outputs.current_date_time }}.apk

    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: apk-files/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/main'

    steps:
    - name: Download APK Artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: apk-files

    - name: List Files
      run: ls -R apk-files

    # ----------------------------
    # ðŸ“Š Grafana Deployment Annotation
    # ----------------------------
    - name: Grafana Deployment Annotation
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
          -H "Content-Type: application/json" \
          ${{ secrets.GRAFANA_URL }}/api/annotations \
          -d '{
            "text": "Android CI/CD Deployment",
            "tags": [
              "github-actions",
              "android",
              "${{ github.ref_name }}"
            ]
          }'

    # ----------------------------
    # ðŸ“ˆ Push Metrics to Grafana (Prometheus)
    # ----------------------------
    - name: Push CI Metrics to Grafana
      run: |
        echo "android_ci_build_success{branch=\"${{ github.ref_name }}\"} 1" | \
        curl -u "${{ secrets.PROM_USERNAME }}:${{ secrets.PROM_PASSWORD }}" \
        --data-binary @- \
        ${{ secrets.PROM_PUSHGATEWAY_URL }}/job/android-ci

